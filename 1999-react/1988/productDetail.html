<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta type="description" content="供应商-商品详情">
    <title>商品详情</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./plugins/layui/css/layui.css">
    <link rel="stylesheet" href="./plugins/font-awesome/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="./build/css/publicHead.css">
    <link rel="stylesheet" href="./build/css/goodsdetail.css">
</head>
<body style="padding: 0px 30px; background-color: #f1f5fa;">
	<div class="layui-layout layui-layout-admin" id="goodsDetail" style="width: 100%; background-color: #ffffff;">
		<!-- 商品信息  开始-->
		<div class="goodsInfo" style="padding-top: 40px;">
			<div class="leftImgShow">
				<div class="bigImgBox">
					<img src=""/>
				</div>
				<div class="smallImgBox">
					<a href="javascript:;" class="btn-a left-btn-a" id="gd_prevA"><i class="fa fa-chevron-left"></i></a>
					<ul id="pictureInfo"></ul>
					<a href="javascript:;" class="btn-a right-btn-a" id="gd_nextA"><i class="fa fa-chevron-right"></i></a>
				</div>
			</div>
			<div class="middleInfo">
				<div class="info-title">
					<p></p>
				</div>
				<div class="infoPriceList">
					<table border="0px" width="100%" cellspacing="0" cellpadding="0">
						<tr>
							<td id="theVendorPrice">
								<span class="pr_title">供货价：</span>
								<span class="orange"></span><i>￥</i><em></em></span>
							</td>
							<td id="theMarketPrice">
								<span class="pr_title"><del>市场零售价：</del></span>
								<span class="orange"></span><i>￥</i><s></s></span>
							</td>
						</tr>
						<tr>
							<td id="theSuggestPrice">
								<span class="pr_title">建议零售价：</span>
								<span class="orange"><i>￥</i><em></em></span>
							</td>
							<td></td>
						</tr>
					</table>
				</div>
				<div class="info-priceRange layui-hide">
					<div class="pr_content">
						<div class="pr_content_box">
							<table border="0px" cellspacing="0" cellpadding="0">
								<tr id="vendorPrice"></tr>
								<tr id="minNum"></tr>
							</table>
						</div>
					</div>
				</div>
				<div class="info-other">
					<table border="0px" cellspacing="0" cellpadding="0">
						<!--<tr class="salesPromo">
							<td><span class="pr_title">促销：</span></td>
							<td><span class="orange">本店满600元可用30元补货券，支持跨店使用</span></td>
						</tr>-->
						<!-- <tr class="distribution" id="distribution">
							<td><span class="pr_title">配送：</span></td>
							<td>
								<span id="freightStratAddress"></span>
								至
								<select name="province" id="province"></select>
								<span id="freightTotalPrice"><span>
							</td>
						</tr> -->
						<tr>
							<td><span class="pr_title">购买限制：</span></td>
							<td>
								<label style="display: inline-block;margin-right: 20px;">
									最小购买量&nbsp;<span id="minBuyNumSpan"></span>&nbsp;
									<span class="unitNameSpan"></span>
								</label>
								<label style="display: inline-block;margin-left: 20px;">
									最大购买量&nbsp;<span id="maxBuyNumSpan"></span>&nbsp;
									<span class="unitNameSpan"></span>
								</label>
							</td>
						</tr>
						<tr class="specifications" id="skuList"></tr>
						<tr class="specifications" id="skuMap"></tr>
					</table>
					<div class="presaleInfo layui-hide" id="presaleInfo">
						<span>预售商品：</span>
						<span id="presaleDate"></span>
						<span id="presaleType"></span>
					</div>
					<div class="submitBox">
						<a href="product-list.html" class="buyNow">返回列表</a>
					</div>
					<!-- <div class="submitBox">
						<a href="javascript:;" class="buyNow" onclick="buyNow();">立即购买</a>
						<a href="javascript:;" class="AddtoCart" onclick="addToCart();"><i class="fa fa-shopping-cart"></i>&nbsp;&nbsp;加入进货单</a>
					</div> -->
				</div>
			</div>
			
				
		</div>
		<!-- 商品信息  结束-->
		<div class="gd-container">
				<!--主体内容开始-->
			  <div class="grid_wrap">
				  <div class="cont-leftBox">
					  <div class="module cont-left-search" style="border: none">
						  <!-- <div class="search-title">
							  店内搜索
						  </div>
						  <div class="search-content">
							  <div class="content-row">
								  <label for="">关键字</label>
								  <input type="text" name="keyword" id="" value="" />
							  </div>
							  <div class="content-row">
								  <label for="">价&emsp;格</label>
								  <input type="text" class="cont-price priceBegin" name="priceBegin" id="priceBegin" value="" />
								  到
								  <input type="text" class="cont-price priceEnd" name="priceEnd" id="priceEnd" value="" />
							  </div>
						  </div> -->
						  <!-- <div class="search-title">
								  店内搜索记录
						  </div> -->
						  <!-- <div class="search-content">
							  <ul id="storeSearch">
								  <li>
									  <i class="search-plus-i"></i>
									  <span>热卖爆款</span>
								  </li>
							  </ul>
						  </div> -->
					  </div>
					  <div class="cont-left-hotSell" style="margin-top: 0">
						  <div class="hotSell-title">
							  店铺热销
						  </div>
						  <div class="hotSell-content">
							  <ul id="hotSellBox"></ul>
						  </div>
					  </div>
				  </div>
					  <div class="cont-rightBox">
						  <div class="layui-tab layui-tab-brief orange-tab" lay-filter="docDemoTabBrief">
							  <ul class="layui-tab-title">
								  <li class="layui-this">商品介绍</li>
								  <li>商品属性</li>
								  <li>工厂企业信息</li>
							  </ul>
							  <div class="layui-tab-content" style="min-height: 100px;">
								  <div class="layui-tab-item layui-show" style="text-align: center; padding-top: 50px;" id="productIntroduce">
									  <!--商品介绍-->
								  </div>
								  <div class="layui-tab-item attributes-list" id="productAttribute">
									  <!--商品属性-->
									  <ul id="productAttrUl">
	  
									  </ul>
								  </div>
								  <div class="layui-tab-item" id="factoryInfo">
									  <!--工厂企业信息-->
									  <ul id="factoryInfoUl">
										  <li class="factoryLogo" id="factoryLogo">
											  <img src="build/images/placeholder.jpg" width="100px" height="100px" />
										  </li>
										  <li>
											  <h1 id="sellerCompanyName-h1" style="font-size:24px;font-weight:700;"></h1>
											  <label class="contactWay" id="contactWay">
												  <span>联系方式</span>
												  <i class="fa fa-mobile-phone"></i>
											  </label>
											  <!-- <label class="woXinContact">
												  <span>我信联系</span>
												  <i class="fa fa-commenting-o fa-fw contactSupplier"></i>
											  </label> -->
										  </li>
										  <li>
											  <label class="factoryComAddressBox">
												  <span>所在地：</span>
												  <span id="factoryComAddress"></span>
											  </label>
										  </li>
									  </ul>
									  <div id="factoryMsg"></div>
								  </div>
							  </div>
						  </div>
					  </div>
			  </div>
			  <!--主体内容结束-->
	  
			  <!--右侧悬停 区域  开始-->
				  <!-- <div class="rightTools" id="rightTools">
					  <ul>
						  <li>
							  <a href=" ../buyCartModule/cart/index.html" target="_blank" class="toolsLeft">进货单</a>
							  <a href=" ../buyCartModule/cart/index.html" target="_blank" class="toolsRight"><i class="fa fa-shopping-cart"></i></a>
						  </li>
						  <li>
							  <a href="javascript:;" class="toolsLeft">电话</a>
							  <a href="javascript:;" class="toolsRight"><i class="fa fa-phone"></i></a>
						  </li>
						  <li>
							  <a href="javascript:;" class="toolsLeft">回顶部</a>
							  <a href="javascript:;" class="toolsRight"><i class="fa fa-angle-up"></i></a>
						  </li>
					  </ul>
				  </div> -->
				  <!--右侧悬停 区域  结束-->
			  </div>
	  
		  </div>

	</div>
	


<script src="./plugins/layui/layui.all.js"></script> 
<script src="./build/js/wolianwComponent/config.js"></script>
<script src="./build/js/goodsDetails.js"></script>

<script>
    layui.use(['element','jquery', "woLianw"], function () {
        var element = layui.element;
        var $ = layui.jquery;
        var woLianw = layui.woLianw;
        window.productDetails = {};
        //运费模板传参
        window.freightParameter = {};
		//获取商品ID
		var productId = window.location.href.split('?productId=')[1];
		//var productId = 254;
        woLianw.getProductDetail({"productId": productId}, function(data){
        	console.log(data);
			productDetails = data;
			var totalDatas = JSON.parse(localStorage.getItem("1988login"));
			console.log(totalDatas);
			// $("#userName").html('<i class="fa fa-user fa-fw" aria-hidden="true"></i> '+totalDatas.companyName);
			
        	$(".info-title").find("p").text(data.name);
        	leftSmallImg(data.pictureInfoList, "pictureInfo"); //渲染左侧商品小图片
        	$(".bigImgBox").find("img").attr("src", (productDetails.pictureInfoList!=null ? woLianw.getImgUrl(productDetails.pictureInfoList[0]) : "" ));//左侧展示大图

			// woLianw.getLinkage(-1, function(data){			//配送区域
			// 	freightArea(data, totalDatas.provinceId);
			// 	getFreightPrice(productDetails);
        	// });
			//获取快递公司
			// woLianw.getExpressList(function(data){
        	// 	woLianw.renderDataHtml(data, "expressListTemplate", "expressList");  //快递公司列表
			// });

			$("#minBuyNumSpan").html(data.minBuyNum); //最小购买量
			if(data.maxBuyNum){
				$("#maxBuyNumSpan").html(data.maxBuyNum); //最大购买量
			}else{
				$("#maxBuyNumSpan").parent().remove();
			}

        	$(".unitNameSpan").html(data.unitName); //计量单位
        	//如果canNotBuy 为false  不让购买 把 立即购买 和 加入购物车 置灰
        	if(data.canNotBuy){
				$("a.buyNow, a.AddtoCart").attr("disabled", "true").hover(function(){
					layer.msg("限制地区，不能购买！");
				},function(){});
				
			}else if(!data.canNotBuy){
				$("a.buyNow, a.AddtoCart").removeAttr("disabled");
			}

        	//渲染sku 规格属性
        	//woLianw.renderDataHtml(data.skuMap, "specificationsTemplate", "specifications");
			getSkuList(data.skuInfoList, data.skuMap, data.unitName);

			//marketPrice 市场零售价
			if(productDetails.marketPrice){
				var marketPrice = priceChange(productDetails.marketPrice);
				$("#theMarketPrice").find("s").text(marketPrice);
			}else{
				$("#theMarketPrice").hide();
			}

			//vendorPrice 供货价价
			if(productDetails.vendorPrice){
				var vendorPrice = priceChange(productDetails.vendorPrice);
				$("#theVendorPrice").find("em").text(vendorPrice);
			}else{
				$("#theVendorPrice").find("em").text(0);
			}
			

			//建议零售价
			if(productDetails.suggestPrice){
				var suggestPrice = priceChange(productDetails.suggestPrice);
				$("#theSuggestPrice").find("em").text(suggestPrice);
			}else{
				$("#theSuggestPrice").find("em").text(0);
			}

        	//如果阶梯价格的商品
        	if(data.priceType == 1){
        		$("div.info-priceRange").removeClass("layui-hide");
        		getPriceRange(data.ladderPriceList, data.unitName);
        		//渲染
        	}else{
        	//如果普通价格的商品
	        	$("div.info-priceRange").addClass("layui-hide");
	        	//woLianw.renderDataHtml(data.ladderPriceList, "buyPriceTemplate", "buyPrice");
			}

			if(data.isPresale){
				$("#presaleInfo").removeClass("layui-hide");
				$("#presaleDate").html(woLianw.transDateType(data.presaleDate));
				presaleType ? $("#presaleType").html("前发货") : $("#presaleType").html("开始发货");
			}

        	//渲染商品介绍
        	$("#productIntroduce").html(productDetails.content);

			//渲染商品属性（spu(properties)
			$("#productAttrUl").html(getProductAttr(productDetails.properties));
			
			$("#sellerCompanyName-h1").html(data.vendorName);  //工厂名称
			//渲染工厂企业信息
        		//工厂logo
				var $venderLogo = $("#factoryLogo > img");
			if(productDetails.vendorLogo){  //如果verderlogo 不为空
				var imgUrl = woLianw.getImgUrl(productDetails.vendorLogo);
        		$venderLogo.attr("src", imgUrl);
        	}else{
				$venderLogo.attr("src", "../img/woLianwLOGO.jpg");
			}
        	//工厂所在地
        	if(productDetails.province || productDetails.city || productDetails.area){
        		var str = productDetails.province + productDetails.city+ productDetails.area;
        		$("#factoryComAddress").html(str);
        		$("#freightStratAddress").html(str);
			}
			//富文本传过来的 工厂详情信息
			woLianw.getFactoryDetail(function(data){
				$("#factoryMsg").html(data);
			});


			var arr = [];
			arr.push(productDetails.vendorId);
			var parameter = {  //调接口需要的传参
				"vendorId": arr.join(","),  //工厂id
				//"sortColumn": "saleCount",  //
				//"sortOrder": "desc",        //
				"page":1,
				"sortColumn": "sale_count",
				"sortOrder": "desc",
				"limit": 5
			}
			hotSell(parameter);


        });




        $("#skuList").on("click","a.skuListA", function(){
        	$(this).addClass("checked").siblings().removeClass("checked");
        })



        //点击回到顶部
        // $("#rightTools").find("li").eq(2).click(function() {
		// 	$("html, body").animate({ scrollTop: 0 }, "slow");
		// 	return false;
		// });

		//商品详情 展示图片 左右按钮切换
		$("#gd_prevA").click(function(){
			if($("#pictureInfo li").length >= 5){
				var $first = $("#pictureInfo li:first");
				$("#pictureInfo").stop(true).animate({
					//left: -72+"px"
				}, 300, function(){
					var $elem= $first.clone(true);
					$first.remove();
					$("#pictureInfo li:last").after($elem);
					$("#pictureInfo li:first").trigger("click");
				});
			}
			
		});

		$("#gd_nextA").click(function(){
			if($("#pictureInfo li").length >= 5){
				var $last = $("#pictureInfo li:last");
				$("#pictureInfo").stop(true).animate({
					//left: -72+"px"
				}, 300, function(){
					var $elem= $last.clone(true);
					$last.remove();
					$("#pictureInfo li:first").before($elem);
					$("#pictureInfo li:first").trigger("click");
				});
			}
			
		});



		$(function(){
			//sku数量 加减框
			$("#skuMap").on("click", "span i", function(){
				var $inpNum = parseInt($(this).parent().siblings("input").val());
				if($(this).hasClass("fa-minus")){
					if($inpNum !=0){
						$(this).parent().siblings("input").val($inpNum-1);
						//getFreightPrice(productDetails, $inpNum-1);
					}
				}else if($(this).hasClass("fa-plus")){
					var str = $(this).parents("td").prev().text();
					var canSellNum = parseInt(str.split(" ")[0]);  //可售数量
					if($inpNum+1 <= canSellNum){
						$(this).parent().siblings("input").val($inpNum+1);
						//getFreightPrice(productDetails, $inpNum+1);
					}else{
						$(this).parent().siblings("input").val(canSellNum);
						layer.msg("不能超过可售数量！");
					}

				}
			});

			// $("#skuMap").on("blur", "input", function(){

			// });

			$("#skuMap").on("keyup", "input.gd-btn", function(){
				var c = $(this);
				if(/[^\d]/.test(c.val())){ //替换非数字字符
					var temp_amount=c.val().replace(/[^\d]/g,'');
					$(this).val(temp_amount);
				}

				var str = $(this).parent("td").prev().text();
				var canSellNum = parseInt(str.split(" ")[0]);  //可售数量
				var num = parseInt( $(this).val() );
				if(canSellNum < num){
					$(this).val(canSellNum);
					layer.msg("不能超过可售数量！");
				}
			});

			//联系方式
			$("#contactWay").hover(function(){
				var iphone = productDetails.contactPhone;
				if(iphone){
					layer.tips(iphone, $("#contactWay"));
				}else{
					layer.tips("暂无联系方式！", $("#contactWay"));
				}
			},function(){});


			//skuList 数量过多 点击下拉
			// $(".drop-down").on("click", "span", function(){
			// 	if(!$(this).hasClass("drop-up")){
			// 			$(this).parent("").addClass("skuListDivMore");
			// 		$(this).addClass("drop-up");

			// 	}else{
			// 		$(this).removeClass("drop-up");
			// 	}
			// });


			$("#pictureInfo").on({
				onmouseover: function(){
					$(this).addClass("checkLi").siblings().removeClass("checkLi");
				},
				click: function(){
					$(this).addClass("checkLi").siblings().removeClass("checkLi");
					var $url = $(this).find("img").attr("src");
					$(".bigImgBox img").attr("src", $url);
				}
			}, "li");



			//下拉选择 省市区 计算运费
 			$("#distribution").on("change", "select", function(){
				var $province = $("#province").find("option:selected").attr("id");
				getFreightPrice(productDetails);
			});

			$("img").error(function(){
				console.log("图片加载失败！");
				$(this).attr('src','./build/images/placeholder.jpg');
			});


		});


		function getFreightPrice(productDetails, _minBuyNum){
			var buyNum = _minBuyNum || productDetails.minBuyNum;
			var provinceId = $("#province").find("option:selected").attr("id");
			if(!provinceId){       //未选择下拉框（当前默认是“请选择”，没有值 provinceId==undefined）
				$("#freightTotalPrice").text("");
			}else if(productDetails.freightType ==1){   //有运费模板的时候
					var arr = [];
					var parameter =	{
						"productId": productDetails.id, // 商品ID
						"number": buyNum, // 购买数量(默认使用最小购买量)
						"weight": productDetails.weight, // 单件重量，单位千克
						"templateId": productDetails.fareTemplateId // 模板ID
					}
					freightParameter.areaId = provinceId;
					arr.push(parameter);
					freightParameter.orderItems = JSON.stringify(arr);
					woLianw.fareOrderFreight(freightParameter, function(data){
						var freightPrice = data.totalAmount;
						if(freightPrice == "0" || freightPrice == "0.00"){
							$("#freightTotalPrice").text("免运费");
						}else{
							$("#freightTotalPrice").text("￥"+freightPrice);
						}

					});
				}else if(productDetails.freightType ==0){
					$("#freightTotalPrice").text("卖家承担运费");
				}else if(productDetails.freightType ==2){
					$("#freightTotalPrice").text("运费到付");
				}
		}



});


</script>
</body>
</html>
